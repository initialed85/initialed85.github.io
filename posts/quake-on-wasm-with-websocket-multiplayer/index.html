<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Quake on WASM With WebSocket multiplayer | initialed85's misc tech stuff</title>
<meta name=keywords content><meta name=description content="Genesis When I was a kid, my dad taught computing / programming at Alanvale TAFE; he would often bring home old computers from work (I think when they upgraded their machines) and network them together, so we always had computers around the house and I was interested in them from an early age.
The first vivid nightmare I remember was when my older sister let me play a bit of Wolfenstein 3D and I guess it was on her save game where you confront Hitler."><meta name=author content="Edward Beech"><link rel=canonical href=https://initialed85.cc/posts/quake-on-wasm-with-websocket-multiplayer/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://initialed85.cc/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://initialed85.cc/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://initialed85.cc/favicon-32x32.png><link rel=apple-touch-icon href=https://initialed85.cc/apple-touch-icon.png><link rel=mask-icon href=https://initialed85.cc/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://initialed85.cc/posts/quake-on-wasm-with-websocket-multiplayer/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Quake on WASM With WebSocket multiplayer"><meta property="og:description" content="Genesis When I was a kid, my dad taught computing / programming at Alanvale TAFE; he would often bring home old computers from work (I think when they upgraded their machines) and network them together, so we always had computers around the house and I was interested in them from an early age.
The first vivid nightmare I remember was when my older sister let me play a bit of Wolfenstein 3D and I guess it was on her save game where you confront Hitler."><meta property="og:type" content="article"><meta property="og:url" content="https://initialed85.cc/posts/quake-on-wasm-with-websocket-multiplayer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-12T00:53:44+08:00"><meta property="article:modified_time" content="2024-05-12T00:53:44+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Quake on WASM With WebSocket multiplayer"><meta name=twitter:description content="Genesis When I was a kid, my dad taught computing / programming at Alanvale TAFE; he would often bring home old computers from work (I think when they upgraded their machines) and network them together, so we always had computers around the house and I was interested in them from an early age.
The first vivid nightmare I remember was when my older sister let me play a bit of Wolfenstein 3D and I guess it was on her save game where you confront Hitler."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://initialed85.cc/posts/"},{"@type":"ListItem","position":2,"name":"Quake on WASM With WebSocket multiplayer","item":"https://initialed85.cc/posts/quake-on-wasm-with-websocket-multiplayer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Quake on WASM With WebSocket multiplayer","name":"Quake on WASM With WebSocket multiplayer","description":"Genesis When I was a kid, my dad taught computing / programming at Alanvale TAFE; he would often bring home old computers from work (I think when they upgraded their machines) and network them together, so we always had computers around the house and I was interested in them from an early age.\nThe first vivid nightmare I remember was when my older sister let me play a bit of Wolfenstein 3D and I guess it was on her save game where you confront Hitler.","keywords":[],"articleBody":"Genesis When I was a kid, my dad taught computing / programming at Alanvale TAFE; he would often bring home old computers from work (I think when they upgraded their machines) and network them together, so we always had computers around the house and I was interested in them from an early age.\nThe first vivid nightmare I remember was when my older sister let me play a bit of Wolfenstein 3D and I guess it was on her save game where you confront Hitler.\nI just remember walking through one of the doors and there he was with these big machine guns blazing, I nearly leapt backwards through the seat; he was so real, so lifelike- the graphics were incredible:\nWell, they sure seemed incredible at the time- clearly the graphics weren’t that important, the game was plenty gripping as it was.\nI remember the first network multiplayer game I ever played; me and my sister were at work with dad, I think it was the start of the year and he and another teacher were just getting stuff set up, so he brought us in and the other teacher brought his kids in (also a boy and a girl).\nThe other kids took us to one of the computer labs and got us all set up with a game of Doom. I remember being confused as to where the enemies were, the level was just vast an empty- but briefly out of nowhere an enemy appeared moving so fast and just gunned me down where I stood.\nIt happened a few more times and I remarked “wow they’re so fast, how do you even kill them?” which prompted one of the other kids to explain that it was them that I saw and that we’re all playing together in the same game- it absolutely blew my mind.\nI was hooked after that, multiplayer was the future and I was lucky enough to live in it.\nDoom came out in 1993, so I guess I would have been about 8 at the time.\nOutside of that experience, I never really played a lot of Doom- I’m not sure if my parents shut it down or what, but I mostly played racing games and side-scrollers.\nAround 1995 / 1996 I started to get properly into first-person shooters; I remember playing Rise of the Triad, Hexen, Strife and Duke Nukem 3D, but the game I remember most of all…\nThe original Quake.\nIt was groundbreaking- I think it was the only first person shooter at the time with real 3D graphics. It was so dark and gloomy, the enemies were scary, if you used the explosive weapons just right you could cause the enemy to explode into a shower of bodyparts: “gibbed”.\nBut above all, it had multiplayer- both cooperative and deathmatch and boy did I play a lot of it; I’d rally my sister, my nephews and the kid from across the road to occupy some of the computers we had laying around so that we could play Quake, they didn’t mind it, but they didn’t enjoy it nearly as much as me.\nFor years I only had the shareware version; I remember having a magazine that had a review of the full version and I would read it over and over wondering how awesome it would be.\nI can’t remember how or when, but eventually I was able to buy a copy of the full version and it was as good as I hoped it would be, if not better. Me and the gang all started getting serious about deathmatch, now that we had all these dedicated deathmatch levels; mods started getting popular and we installed some bots which made the games even more frantic, it was so much fun.\nAnyway, years went by, other games came and went- I played a lot of Counter Strike 1.6, I played a lot of Quake 3 but I’d regularly come back and play some plain old Quake. I dunno if it truly was that good or if it was just that nostalgic feeling of having my mind blown by how incredible a game was coming back to me.\nI’ve certainly never experienced it since, and there are some very cool games out there these days.\nPaths cross So, fast forward to 2024, some 28 years later and I don’t really play games that much these days; I’m pretty busy writing code for work and I’m pretty busy being a dad- but Quake has just started finding its way back into my life again.\nI noticed it in the Xbox game store, so I installed it and it was terrible- there was nothing wrong with it, it was exactly Quake, but I think I just really hate playing first person shooters with a controller. My son was pretty interested though, but at 4 years old he’s probably best not to play that sort of game (my wife is already a bit annoyed at how he’s growing a fascination for guns, despite neither of us introducing them to him).\nAs tends to happen I find a way to weave the aspects of my life together and in this case, while poking around I discovered that some nice guy had ported Quake to WASM.\nI spun it up, it all worked nicely in the browser and of course my immediate question was “does multiplayer work?”- it turns out the answer was “probably”, but unfortunately in practice, not really.\nThe porter had used Emscripten which is a great choice for this sort of thing and Emscripten promises to provide a degree of transparent BSD-socket-to-WebSocket translation out of the box; such that if the code that previously didn’t know about WASM tries to do stuff with BSD sockets, Emscripten will open a WebSocket to a URL that you can inject and write bytes to it / read bytes from it.\nThis didn’t seem to work for Quake and I couldn’t figure out why- surely it was just a UDP client socket connecting to a UDP server socket? That’s exactly what this sort of thing is built for!\nUnfortunately not. I did a bunch of research and it seems the original Quake protocol (often referred to as “NetQuake”) has all sorts of issues (and this is why QuakeWorld sprung up as a more favoured deathmatch-only Quake multiplayer client and server).\nThe practical issue was that instead of doing the sensible, NAT-friendly thing described above (i.e. a client opens a socket to a server using socket.h::connect(), that socket stays open for bidirectional messaging), NetQuake uses socket.h::bind(), so the socket is listening on a given port and anybody can send it datagrams.\nWhich is exactly what happens; you send datagrams to the Quake server on the control port of 26000 and it will respond to you on that port, but after the initial handshake, the communications will move to another completely random port (advised in the handshake) meaning the server has to have a lot of ports open and exposed to the internet and so does the client!\nThis caused some problems for the Emscripten piece; typically you’d run a simple proxy like websockify and call it a day- but that won’t work here, because the Quake server will send post-handshake messages back to the proxy from a new port (that the proxy doesn’t recognize).\nSo I had no choice but to write a custom Quake WebSocket proxy in order to keep trying- unfortunately I still didn’t get it working, I think more of the “faked out BSD sockets” approach was upsetting the system; things like address comparison checks (inside the Quake client) to know if a connection is good etc were failing resulting in the connection not progressing.\nI thought long and hard about approaches that wouldn’t have me writing any C (language of original Quake source code) but I couldn’t come up with anything; this left me no choice other than implementing a new net_landriver_t for WebSockets, for Quake to use; here’s the interface I needed to implement:\nDoesn’t look too bad! And I won’t need a fair bit of it as well- fortunately Emscripten has a nice C abstraction built around the JavaScript WebSocket client.\nSo, I went and wrote the implementation- it was pretty fun to be honest; I can see there’s a certain beauty and power to C, but I don’t think I’d want to be writing it as part of a team that had juniors; too much to go wrong.\nAn interesting challenge C doesn’t include a lot of batteries and it looks like id Software at least had built a lot of their own things that you might find in the standard library of other languages- I don’t know enough about C to know if this is typical.\nI found myself wanting a FIFO queue in order to couple the asynchronous callbacks for WebSocket onmessage to the synchronous (but non-blocking) Read function I had to implement in net_landriver_t but I couldn’t find anything immediately standing out as available, so I wrote a simple and gross one:\nWriting to it is pretty straightforward (and should probably be in a function):\nAnd so is reading from it:\nIs this idiomatic C? I dunno, probably not if I had to guess- but it does work!\nAlso you might notice the message queue item index as an char- I thought this was a bit clever because now I don’t have to think about pruning the buffer or moving the index backward or anything; the read cursor and write cursor can just chase each other all day and it should all be fine… unless the write cursor laps the read cursor, then I dunno what’ll happen.\nLet’s just hope we don’t fall behind!\nWrapping up The main takeaway of all this is that you can go here and play Quake multiplayer in your browser (if my Kubernetes cluster hasn’t crashed); there might be some bots in there, there might also be some other humans in there, who knows.\nIf you need some more bots, drop down the console and type impulse 100; courtesy of Frikbot.\nIf you want to change the map, click the RCON link and do something like changelevel e3m4.\nHere are the repos:\nMy fork of GMH-Code/Quake-WASM My fork of wyatt8740/Quake-LinuxUpdate The proxy and general packaging ","wordCount":"1722","inLanguage":"en","datePublished":"2024-05-12T00:53:44+08:00","dateModified":"2024-05-12T00:53:44+08:00","author":{"@type":"Person","name":"Edward Beech"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://initialed85.cc/posts/quake-on-wasm-with-websocket-multiplayer/"},"publisher":{"@type":"Organization","name":"initialed85's misc tech stuff","logo":{"@type":"ImageObject","url":"https://initialed85.cc/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://initialed85.cc/ accesskey=h title="initialed85's misc tech stuff (Alt + H)">initialed85's misc tech stuff</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Quake on WASM With WebSocket multiplayer</h1><div class=post-meta><span title='2024-05-12 00:53:44 +0800 +0800'>May 12, 2024</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Edward Beech</div></header><div class=post-content><h2 id=genesis>Genesis<a hidden class=anchor aria-hidden=true href=#genesis>#</a></h2><p>When I was a kid, my dad taught computing / programming at <a href=https://www.tastafe.tas.edu.au/campuses/alanvale-campus>Alanvale TAFE</a>; he would often bring home old computers from work (I think when they upgraded their machines) and network them together, so we always had computers around the house and I was interested in them from an early age.</p><p>The first vivid nightmare I remember was when my older sister let me play a bit of <a href=https://en.wikipedia.org/wiki/Wolfenstein_3D>Wolfenstein 3D</a> and I guess it was on her save game where you confront Hitler.</p><p>I just remember walking through one of the doors and there he was with these big machine guns blazing, I nearly leapt backwards through the seat; he was so real, so lifelike- the graphics were incredible:</p><p><img loading=lazy src=/posts/quake-on-wasm-with-websocket-multiplayer/image-1.png alt=image-1></p><p>Well, they sure seemed incredible at the time- clearly the graphics weren&rsquo;t that important, the game was plenty gripping as it was.</p><p>I remember the first network multiplayer game I ever played; me and my sister were at work with dad, I think it was the start of the year and he and another teacher were just getting stuff set up, so he brought us in and the other teacher brought his kids in (also a boy and a girl).</p><p>The other kids took us to one of the computer labs and got us all set up with a game of <a href=https://en.wikipedia.org/wiki/Doom_(1993_video_game)>Doom</a>. I remember being confused as to where the enemies were, the level was just vast an empty- but briefly out of nowhere an enemy appeared moving so fast and just gunned me down where I stood.</p><p>It happened a few more times and I remarked &ldquo;wow they&rsquo;re so fast, how do you even kill them?&rdquo; which prompted one of the other kids to explain that it was them that I saw and that we&rsquo;re all playing together in the same game- it absolutely blew my mind.</p><p>I was hooked after that, multiplayer was the future and I was lucky enough to live in it.</p><p>Doom came out in 1993, so I guess I would have been about 8 at the time.</p><p><img loading=lazy src=/posts/quake-on-wasm-with-websocket-multiplayer/image-2.png alt=image-2></p><p>Outside of that experience, I never really played a lot of Doom- I&rsquo;m not sure if my parents shut it down or what, but I mostly played racing games and side-scrollers.</p><p>Around 1995 / 1996 I started to get properly into first-person shooters; I remember playing <a href=https://en.wikipedia.org/wiki/Rise_of_the_Triad>Rise of the Triad</a>, <a href=https://en.wikipedia.org/wiki/Heretic_(video_game)>Hexen</a>, <a href=https://en.wikipedia.org/wiki/Strife_(1996_video_game)>Strife</a> and <a href=https://en.wikipedia.org/wiki/Duke_Nukem_3D>Duke Nukem 3D</a>, but the game I remember most of all&mldr;</p><p><img loading=lazy src=/posts/quake-on-wasm-with-websocket-multiplayer/image-3.png alt=image-3></p><p>The original <a href=https://en.wikipedia.org/wiki/Quake_(video_game)>Quake</a>.</p><p>It was groundbreaking- I think it was the only first person shooter at the time with real 3D graphics. It was so dark and gloomy, the enemies were scary, if you used the explosive weapons just right you could cause the enemy to explode into a shower of bodyparts: &ldquo;<a href=https://quakewiki.org/wiki/Gib>gibbed</a>&rdquo;.</p><p>But above all, it had multiplayer- both cooperative and deathmatch and boy did I play a lot of it; I&rsquo;d rally my sister, my nephews and the kid from across the road to occupy some of the computers we had laying around so that we could play Quake, they didn&rsquo;t mind it, but they didn&rsquo;t enjoy it nearly as much as me.</p><p>For years I only had the shareware version; I remember having a magazine that had a review of the full version and I would read it over and over wondering how awesome it would be.</p><p>I can&rsquo;t remember how or when, but eventually I was able to buy a copy of the full version and it was as good as I hoped it would be, if not better. Me and the gang all started getting serious about deathmatch, now that we had all these dedicated deathmatch levels; mods started getting popular and we installed some bots which made the games even more frantic, it was so much fun.</p><p>Anyway, years went by, other games came and went- I played a lot of Counter Strike 1.6, I played a lot of Quake 3 but I&rsquo;d regularly come back and play some plain old Quake. I dunno if it truly was that good or if it was just that nostalgic feeling of having my mind blown by how incredible a game was coming back to me.</p><p>I&rsquo;ve certainly never experienced it since, and there are some very cool games out there these days.</p><h2 id=paths-cross>Paths cross<a hidden class=anchor aria-hidden=true href=#paths-cross>#</a></h2><p>So, fast forward to 2024, some 28 years later and I don&rsquo;t really play games that much these days; I&rsquo;m pretty busy writing code for work and I&rsquo;m pretty busy being a dad- but Quake has just started finding its way back into my life again.</p><p>I noticed it in the Xbox game store, so I installed it and it was terrible- there was nothing wrong with it, it was exactly Quake, but I think I just really hate playing first person shooters with a controller. My son was pretty interested though, but at 4 years old he&rsquo;s probably best not to play that sort of game (my wife is already a bit annoyed at how he&rsquo;s growing a fascination for guns, despite neither of us introducing them to him).</p><p>As tends to happen I find a way to weave the aspects of my life together and in this case, while poking around I discovered that <a href=https://www.m-h.org.uk/>some nice guy</a> had <a href=https://github.com/GMH-Code/Quake-WASM>ported Quake to WASM</a>.</p><p>I spun it up, it all worked nicely in the browser and of course my immediate question was &ldquo;does multiplayer work?&rdquo;- it turns out the answer was &ldquo;probably&rdquo;, but unfortunately in practice, not really.</p><p>The porter had used <a href=https://emscripten.org/>Emscripten</a> which is a great choice for this sort of thing and Emscripten promises to provide <a href="https://emscripten.org/docs/porting/networking.html?highlight=network#emulated-posix-tcp-sockets-over-websockets">a degree of transparent BSD-socket-to-WebSocket</a> translation out of the box; such that if the code that previously didn&rsquo;t know about WASM tries to do stuff with BSD sockets, Emscripten will open a WebSocket to a URL that you can inject and write bytes to it / read bytes from it.</p><p>This didn&rsquo;t seem to work for Quake and I couldn&rsquo;t figure out why- surely it was just a UDP client socket connecting to a UDP server socket? That&rsquo;s exactly what this sort of thing is built for!</p><p>Unfortunately not. I did a bunch of research and it seems the original Quake protocol (often referred to as &ldquo;NetQuake&rdquo;) has all sorts of issues (and this is why <a href=https://en.wikipedia.org/wiki/Quake_(video_game)#QuakeWorld>QuakeWorld</a> sprung up as a more favoured deathmatch-only Quake multiplayer client and server).</p><p>The practical issue was that instead of doing the sensible, NAT-friendly thing described above (i.e. a client opens a socket to a server using <code>socket.h::connect()</code>, that socket stays open for bidirectional messaging), NetQuake uses <code>socket.h::bind()</code>, so the socket is listening on a given port and anybody can send it datagrams.</p><p>Which is exactly what happens; you send datagrams to the Quake server on the control port of <code>26000</code> and it will respond to you on that port, but after the initial handshake, the communications will move to another completely random port (advised in the handshake) meaning the server has to have a lot of ports open and exposed to the internet and so does the client!</p><p>This caused some problems for the Emscripten piece; typically you&rsquo;d run a simple proxy like <a href=https://github.com/novnc/websockify>websockify</a> and call it a day- but that won&rsquo;t work here, because the Quake server will send post-handshake messages back to the proxy from a new port (that the proxy doesn&rsquo;t recognize).</p><p>So I had no choice but to write a <a href=https://github.com/initialed85/quake-websocket-proxy>custom Quake WebSocket proxy</a> in order to keep trying- unfortunately I still didn&rsquo;t get it working, I think more of the &ldquo;faked out BSD sockets&rdquo; approach was upsetting the system; things like address comparison checks (inside the Quake client) to know if a connection is good etc were failing resulting in the connection not progressing.</p><p>I thought long and hard about approaches that wouldn&rsquo;t have me writing any C (language of original Quake source code) but I couldn&rsquo;t come up with anything; this left me no choice other than implementing a new <code>net_landriver_t</code> for WebSockets, for Quake to use; here&rsquo;s the interface I needed to implement:</p><p><img loading=lazy src=/posts/quake-on-wasm-with-websocket-multiplayer/image-4.png alt=image-4></p><p>Doesn&rsquo;t look too bad! And I won&rsquo;t need a fair bit of it as well- fortunately Emscripten has a nice <a href=https://github.com/emscripten-core/emscripten/blob/main/system/include/emscripten/websocket.h>C abstraction built around the JavaScript WebSocket client</a>.</p><p>So, I <a href=https://github.com/initialed85/Quake-WASM/blob/master/WinQuake/net_websocket.c>went and wrote the implementation</a>- it was pretty fun to be honest; I can see there&rsquo;s a certain beauty and power to C, but I don&rsquo;t think I&rsquo;d want to be writing it as part of a team that had juniors; too much to go wrong.</p><h2 id=an-interesting-challenge>An interesting challenge<a hidden class=anchor aria-hidden=true href=#an-interesting-challenge>#</a></h2><p>C doesn&rsquo;t include a lot of batteries and it looks like <a href=https://www.idsoftware.com/>id Software</a> at least had built a lot of their own things that you might find in the standard library of other languages- I don&rsquo;t know enough about C to know if this is typical.</p><p>I found myself wanting a FIFO queue in order to couple the asynchronous callbacks for WebSocket <code>onmessage</code> to the synchronous (but non-blocking) <code>Read</code> function I had to implement in <code>net_landriver_t</code> but I couldn&rsquo;t find anything immediately standing out as available, so I wrote a simple and gross one:</p><p><img loading=lazy src=/posts/quake-on-wasm-with-websocket-multiplayer/image-5.png alt=image-5></p><p>Writing to it is pretty straightforward (and should probably be in a function):</p><p><img loading=lazy src=/posts/quake-on-wasm-with-websocket-multiplayer/image-6.png alt=image-6></p><p>And so is reading from it:</p><p><img loading=lazy src=/posts/quake-on-wasm-with-websocket-multiplayer/image-7.png alt=image-7></p><p>Is this idiomatic C? I dunno, probably not if I had to guess- but it does work!</p><p>Also you might notice the message queue item index as an char- I thought this was a bit clever because now I don&rsquo;t have to think about pruning the buffer or moving the index backward or anything; the read cursor and write cursor can just chase each other all day and it should all be fine&mldr; unless the write cursor laps the read cursor, then I dunno what&rsquo;ll happen.</p><p>Let&rsquo;s just hope we don&rsquo;t fall behind!</p><h2 id=wrapping-up>Wrapping up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h2><p>The main takeaway of all this is that you can go here and play <a href=https://quake.initialed85.cc/>Quake multiplayer in your browser</a> (if my Kubernetes cluster hasn&rsquo;t crashed); there might be some bots in there, there might also be some other humans in there, who knows.</p><p>If you need some more bots, drop down the console and type <code>impulse 100</code>; courtesy of <a href=https://www.insideqc.com/frikbot/fbx/>Frikbot</a>.</p><p>If you want to change the map, click the RCON link and do something like <code>changelevel e3m4</code>.</p><p>Here are the repos:</p><ul><li><a href=https://github.com/initialed85/Quake-WASM>My fork of GMH-Code/Quake-WASM</a></li><li><a href=https://github.com/initialed85/Quake-LinuxUpdate>My fork of wyatt8740/Quake-LinuxUpdate</a></li><li><a href=https://github.com/initialed85/quake-websocket-proxy>The proxy and general packaging</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//initialed85.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://initialed85.cc/>initialed85's misc tech stuff</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>